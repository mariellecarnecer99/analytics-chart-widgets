<template>
  <div>
    <grid-layout
      :layout="widgets"
      :col-num="12"
      :row-height="100"
      :is-draggable="true"
      :is-resizable="true"
      :vertical-compact="true"
      :auto-size="true"
      :use-css-transforms="true"
    >
      <grid-item
        v-for="item in widgets"
        :key="item.i"
        :x="item.x"
        :y="item.y"
        :w="item.w"
        :h="item.h"
        :i="item.i"
        @click="handleSelectedChart(item.i)"
        class="active"
      >
        <ChartData
          :chartType="item.chart?.value"
          :chartLib="item.selectedLib"
          :chartId="item.i"
          :control="item.selectedControl"
          :selectedChartsLength="widgets.length"
          :chartTitle="title"
          :desc="description"
          :widgets="item"
          :selectedWidgets="widgets"
          :chartData="item.data"
          :modifiedChart="item.i === specificItemId ? modifiedChart : null"
          :selectedOrientation="item.i === specificItemId ? selectedOrientation : null"
          :datexFilter="item.i === specificItemId ? xDates : null"
          :dateyFilter="item.i === specificItemId ? yRandom : null"
          :chartJson="item.i === specificItemId ? chartJson : null"
          :uploadedData="item.i === specificItemId ? uploadedData : null"
          :serviceUrl="item.i === specificItemId ? serviceUrl : null"
          :bgColor="item.i === specificItemId ? gridColor : null"
          :bgSwitch="item.i === specificItemId ? gridLinesSwitch : false"
          :chartFont="item.i === specificItemId ? fontType : null"
          :chartFontSize="item.i === specificItemId ? fontSize : null"
          :chartFontColor="item.i === specificItemId ? labelColor : null"
          :chartPlotTitle="item.i === specificItemId ? mainTitle : null"
          :chartPlotTitleSwitch="item.i === specificItemId ? titleSwitch : false"
          :chartPlotTitleFont="item.i === specificItemId ? titleFontType : null"
          :chartPlotTitleFontSize="item.i === specificItemId ? titleFontSize : null"
          :chartPlotTitleFontColor="item.i === specificItemId ? titleColor : null"
          :chartTickLabelsSwitch="item.i === specificItemId ? tickLabelsSwitch : null"
          :chartTickMarkersSwitch="item.i === specificItemId ? tickMarkersSwitch : null"
        />
        <span class="remove deleteChart" @click="removeItem(item.i)"
          ><v-icon size="small">mdi-close</v-icon></span
        >
      </grid-item>
    </grid-layout>
  </div>
  <v-navigation-drawer v-if="widgets.length != 0" app permanent location="right" :width="400">
    <v-list-item
      prepend-icon="mdi-database-outline"
      title="Data & Properties"
      class="my-2"
    ></v-list-item>

    <v-divider></v-divider>

    <v-tabs v-model="tab" fixed-tabs color="primary">
      <v-tab value="setup"> Setup </v-tab>
      <v-tab value="style"> Style </v-tab>
    </v-tabs>

    <v-container fluid>
      <v-window v-model="tab">
        <v-window-item value="setup">
          <v-expansion-panels>
            <v-expansion-panel>
              <v-expansion-panel-title>
                <div>
                  <div v-if="chartImg">
                    <img :src="chartImg" style="width: 25px" />
                    <span class="ml-2">{{ chartName }}</span>
                  </div>

                  <div v-else>
                    <v-icon size="large">mdi-chart-box-outline</v-icon>
                    <span class="ml-2"> Chart</span>
                  </div>
                </div>
              </v-expansion-panel-title>
              <v-expansion-panel-text>
                <div class="text-h2 pa-4">
                  <v-row no-gutters>
                    <v-col v-for="item in charts" class="mr-5 d-flex justify-center">
                      <img
                        :src="item.img"
                        style="width: 25px; height: 25px"
                        @click="handleChartChange(item)"
                      />
                    </v-col>
                  </v-row>
                </div>
              </v-expansion-panel-text>
            </v-expansion-panel>
          </v-expansion-panels>

          <v-row>
            <v-col>
              <p class="mt-5 mb-2">Orientation</p>
              <v-tabs
                v-model="selectedOrientation"
                fixed-tabs
                active-class="active-tab white--text"
              >
                <v-tab
                  v-for="item in chartOrientation"
                  :key="item.value"
                  :value="item.value"
                  :border="true"
                  color="primary"
                  density="comfortable"
                  @click="handleGetOrientation(item.value)"
                >
                  {{ item.type }}
                </v-tab>
              </v-tabs>
            </v-col>
          </v-row>
          <v-row class="my-0">
            <v-col>
              <p class="mb-2">Date control filter</p>
              <VueDatePicker
                v-model="dateControl"
                placeholder="Select Date"
                format="MM/dd/yyyy"
                range
                menu-class-name="dp-custom-menu"
                teleport-center
                @update:model-value="handleDates"
              />
            </v-col>
          </v-row>
          <v-row class="my-0">
            <v-col>
              <p class="mb-2">Data Source</p>
              <v-row>
                <v-col>
                  <v-btn
                    variant="outlined"
                    color="primary"
                    class="uploadData"
                    :loading="isLoading"
                    @click="handleUploadedFile"
                    ><v-icon>mdi-upload</v-icon> Upload Data</v-btn
                  >
                  <input
                    ref="uploadedFile"
                    class="d-none"
                    type="file"
                    accept=".csv"
                    @change="onUploadChange"
                  />
                </v-col>
              </v-row>
              <v-row class="my-0">
                <v-col class="pt-2 pb-0">
                  <v-btn
                    variant="text"
                    color="primary"
                    :loading="isSelecting"
                    @click="handleFileImport"
                    ><v-icon size="large">mdi-plus-circle-outline</v-icon>
                    <span class="ml-2">Blend Data</span></v-btn
                  >
                  <input
                    ref="uploader"
                    class="d-none"
                    type="file"
                    accept=".csv"
                    @change="onFileChanged"
                  />
                </v-col>
              </v-row>
              <v-row class="my-0">
                <v-col class="pt-2 pb-0">
                  <v-text-field
                    v-model="selectedApi"
                    label="Service URL"
                    variant="outlined"
                    density="compact"
                    clearable
                    @update:modelValue="getApiData"
                  ></v-text-field>
                </v-col>
              </v-row>
              <v-row class="my-0">
                <v-col class="pt-2 pb-0">
                  <p class="mb-2">JSON Editor</p>
                  <Vue3JsonEditor
                    v-model="chartsConfig"
                    :expandedOnStart="true"
                    mode="code"
                    @json-change="onJsonChange"
                  />
                </v-col>
              </v-row>
            </v-col>
          </v-row>
          <v-row class="my-0">
            <v-col>
              <p class="mb-2">
                Preview Chart
                <span
                  ><v-btn
                    class="ml-3"
                    size="small"
                    color="primary"
                    @click="handleDownloadChart(specificItemId)"
                    ><v-icon class="mr-1">mdi-download-outline</v-icon>Download</v-btn
                  >
                </span>
              </p>
              <PluggableWidget
                :chartLib="selectedChartLib"
                :option="chartsConfig"
                :id="specificItemId"
              />
            </v-col>
          </v-row>
          <v-row class="my-0">
            <v-col>
              <p class="mb-2">Insert code into website</p>
              <v-textarea
                :model-value="`<chart-widget id='${specificItemId}'></chart-widget>`"
                id="tocopy"
                variant="outlined"
                density="compact"
                auto-grow
                append-inner-icon="mdi-content-copy"
              ></v-textarea>
            </v-col>
          </v-row>
        </v-window-item>

        <v-window-item value="style">
          <v-row>
            <v-col>
              <h4 class="mb-3">Defaults</h4>
              <v-row justify="start">
                <v-col cols="6">
                  <p class="pb-3">Plot Background</p>
                  <v-text-field
                    v-model="gridColor"
                    hide-details
                    class="ma-0 pa-0"
                    variant="outlined"
                    density="compact"
                  >
                    <template v-slot:append-inner>
                      <v-menu
                        v-model="gridColorMenu"
                        location="end"
                        nudge-bottom="105"
                        nudge-left="16"
                        :close-on-content-click="false"
                      >
                        <template v-slot:activator="{ props }">
                          <div
                            v-bind="props"
                            :style="{
                              backgroundColor: getGridColor,
                              cursor: 'pointer',
                              width: '30px',
                              height: '30px',
                              borderRadius: gridColorMenu ? '50%' : '4px',
                              transition: 'border-radius 200ms ease-in-out'
                            }"
                          ></div>
                        </template>
                        <v-card>
                          <v-card-text class="pa-0">
                            <v-color-picker v-model="gridColor" flat></v-color-picker>
                          </v-card-text>
                        </v-card>
                      </v-menu>
                    </template>
                  </v-text-field>
                </v-col>

                <v-col cols="6">
                  <p class="pb-3">Font Type</p>
                  <v-select
                    v-model="fontType"
                    :items="fonts"
                    label="Select ..."
                    variant="outlined"
                    density="compact"
                  ></v-select>
                </v-col>
              </v-row>

              <v-row class="my-0">
                <v-col cols="6">
                  <p class="pb-3">Font Size</p>
                  <v-text-field
                    v-model="fontSize"
                    type="number"
                    variant="outlined"
                    density="compact"
                  ></v-text-field>
                </v-col>

                <v-col cols="6">
                  <p class="pb-3">Font Color</p>
                  <v-text-field
                    v-model="labelColor"
                    hide-details
                    class="ma-0 pa-0"
                    variant="outlined"
                    density="compact"
                  >
                    <template v-slot:append-inner>
                      <v-menu
                        v-model="menuLabelColor"
                        location="end"
                        nudge-bottom="105"
                        nudge-left="16"
                        :close-on-content-click="false"
                      >
                        <template v-slot:activator="{ props }">
                          <div
                            v-bind="props"
                            :style="{
                              backgroundColor: labelColor,
                              cursor: 'pointer',
                              width: '30px',
                              height: '30px',
                              borderRadius: menuLabelColor ? '50%' : '4px',
                              transition: 'border-radius 200ms ease-in-out'
                            }"
                          ></div>
                        </template>
                        <v-card>
                          <v-card-text class="pa-0">
                            <v-color-picker v-model="labelColor" flat></v-color-picker>
                          </v-card-text>
                        </v-card>
                      </v-menu>
                    </template>
                  </v-text-field>
                </v-col>
              </v-row>

              <h4 class="mb-3">Title</h4>
              <v-row justify="start">
                <v-col cols="6">
                  <p class="pb-3">Plot Title</p>
                  <v-text-field
                    v-model="mainTitle"
                    variant="outlined"
                    density="compact"
                  ></v-text-field>
                </v-col>
                <v-col cols="6">
                  <p class="pb-3">Font Type</p>
                  <v-select
                    v-model="titleFontType"
                    :items="fonts"
                    label="Select ..."
                    variant="outlined"
                    density="compact"
                  ></v-select>
                </v-col>
              </v-row>

              <v-row class="my-0">
                <v-col cols="6">
                  <p class="pb-3">Font Size</p>
                  <v-text-field
                    v-model="titleFontSize"
                    type="number"
                    variant="outlined"
                    density="compact"
                  ></v-text-field>
                </v-col>
                <v-col cols="6">
                  <p class="pb-3">Font Color</p>
                  <v-text-field
                    v-model="titleColor"
                    hide-details
                    class="ma-0 pa-0"
                    variant="outlined"
                    density="compact"
                  >
                    <template v-slot:append-inner>
                      <v-menu
                        v-model="menuTitleColor"
                        location="end"
                        nudge-bottom="105"
                        nudge-left="16"
                        :close-on-content-click="false"
                      >
                        <template v-slot:activator="{ props }">
                          <div
                            v-bind="props"
                            :style="{
                              backgroundColor: titleColor,
                              cursor: 'pointer',
                              width: '30px',
                              height: '30px',
                              borderRadius: menuTitleColor ? '50%' : '4px',
                              transition: 'border-radius 200ms ease-in-out'
                            }"
                          ></div>
                        </template>
                        <v-card>
                          <v-card-text class="pa-0">
                            <v-color-picker v-model="titleColor" flat></v-color-picker>
                          </v-card-text>
                        </v-card>
                      </v-menu>
                    </template>
                  </v-text-field>
                </v-col>
              </v-row>

              <h4 class="mb-3">Visibility</h4>
              <v-row column>
                <v-col cols="3">
                  <p class="py-4">Plot Title</p>
                </v-col>
                <v-col cols="3">
                  <v-switch v-model="titleSwitch"></v-switch>
                </v-col>

                <v-col cols="3">
                  <p class="py-4">Grid Lines</p>
                </v-col>
                <v-col cols="3">
                  <v-switch v-model="gridLinesSwitch"></v-switch>
                </v-col>

                <v-col cols="3">
                  <p class="py-4">Tick Labels</p>
                </v-col>
                <v-col>
                  <v-switch v-model="tickLabelsSwitch"></v-switch>
                </v-col>

                <v-col cols="3">
                  <p class="py-4">Tick Markers</p>
                </v-col>
                <v-col>
                  <v-switch v-model="tickMarkersSwitch"></v-switch>
                </v-col>
              </v-row>
            </v-col>
          </v-row>
        </v-window-item>
      </v-window>
    </v-container>
  </v-navigation-drawer>
</template>

<script>
import ChartData from './components/charts/ChartData.vue'
import VueDatePicker from '@vuepic/vue-datepicker'
import '@vuepic/vue-datepicker/dist/main.css'
import { getReport } from '../../dashboard/src/services/reports'
import { Vue3JsonEditor } from 'vue3-json-editor'
import line from './assets/line.png'
import bar from './assets/bar.png'
import pie from './assets/pie.png'
import scatter from './assets/scatter.png'
import table from './assets/table.png'
import moment from 'moment'
import domtoimage from 'dom-to-image'
import { saveAs } from 'file-saver'
import axios from 'axios'
export default {
  components: {
    ChartData,
    VueDatePicker,
    Vue3JsonEditor
  },
  inject: ['eventBus'],
  data: () => {
    return {
      title: null,
      description: null,
      drawer: false,
      tab: null,
      chartOrientation: [
        {
          type: 'Vertical',
          value: 'vertical'
        },
        {
          type: 'Horizontal',
          value: 'horizontal'
        }
      ],
      selectedOrientation: null,
      dateControl: [],
      selectedApi: null,
      isLoading: false,
      isSelecting: false,
      chartsConfig: null,
      gridColor: '#ccc',
      gridColorMenu: false,
      fonts: ['sans-serif', 'serif', 'monospace', 'Arial', 'Courier New', 'Helvetica'],
      fontType: 'sans-serif',
      fontSize: 12,
      labelColor: '#333',
      menuLabelColor: false,
      mainTitle: 'My Chart',
      titleFontType: 'sans-serif',
      titleFontSize: 18,
      titleColor: '#333',
      menuTitleColor: false,
      titleSwitch: false,
      gridLinesSwitch: false,
      tickLabelsSwitch: true,
      tickMarkersSwitch: false,
      charts: [
        {
          type: 'Line Chart',
          value: 'line',
          img: line
        },
        {
          type: 'Bar Chart',
          value: 'bar',
          img: bar
        },
        {
          type: 'Pie Chart',
          value: 'pie',
          img: pie
        },
        {
          type: 'Scatter Chart',
          value: 'scatter',
          img: scatter
        },
        {
          type: 'Table Chart',
          value: 'table',
          img: table
        }
      ],
      chartImg: null,
      chartName: null,
      modifiedChart: null,
      specificItemId: null,
      xDates: null,
      yRandom: null,
      chartJson: null,
      uploadFile: [],
      defaultCategory: null,
      defaultMetric: null,
      uploadedData: {},
      serviceUrl: {},
      selectedChartLib: null
    }
  },
  props: {
    widgets: Array
  },
  computed: {
    getGridColor() {
      const { gridColor } = this
      return gridColor
    }
  },
  mounted() {
    if (this.$route.params.id) {
      this.handleGetReportsById(this.$route.params.id)
    }
  },
  methods: {
    removeItem(i) {
      // console.log('val: ', val);
      // console.log('i: ', i)
      // if (e.key === 'Backspace') {
      //   console.log('e.key: ', e.key)
      const index = this.widgets.map((item) => item.i).indexOf(i)
      this.widgets.splice(index, 1)
      this.widgets.forEach((item, index) => {
        item.i = index
      })
      // }
    },

    handleGetReportsById(e) {
      getReport(e)
        .then((response) => {
          this.title = response.data.name
          this.description = response.data.description
        })
        .catch(() => {})
        .finally()
    },

    handleSelectedChart(id) {
      this.specificItemId = id
      this.handleChartJson(id)
      this.handleChartLib(id)
      const selectedChart = document.querySelectorAll('.active')

      for (let i = 0; i < selectedChart.length; i++) {
        selectedChart[i].style.border = `1px solid ${i === id ? '#463d6e' : 'transparent'}`
      }

      const deleteBtn = document.querySelectorAll('.deleteChart')

      for (let i = 0; i < deleteBtn.length; i++) {
        deleteBtn[i].style.display = `${i === id ? 'block' : 'none'}`
      }
    },

    handleChartLib(id) {
      const targetObject = this.widgets.find((item) => item.i === id)
      this.selectedChartLib = targetObject?.selectedLib
    },

    handleChartChange(val) {
      this.chartImg = val.img
      this.chartName = val.type
      this.modifiedChart = val.value
    },

    handleGetOrientation(val) {
      this.selectedOrientation = val
    },

    handleDates(date) {
      if (date) {
        const dateMapped = date.map((item) => {
          return moment(item).format('L')
        })
        this.getDaysBetweenDates(dateMapped)
      }
    },

    getDaysBetweenDates(dates) {
      const resultObject = {
        startDate: dates[0],
        endDate: dates[1]
      }

      const newDates = []
      const randomNumbers = []
      const currDate = moment(resultObject.startDate).startOf('day')
      const lastDate = moment(resultObject.endDate).startOf('day')

      while (currDate.clone().isSameOrBefore(lastDate)) {
        newDates.push(currDate.format('L'))
        currDate.add(1, 'days')
        this.xDates = newDates
        randomNumbers.push(Math.round(Math.random() * 100))
        this.yRandom = randomNumbers
      }
      return newDates
    },

    handleDownloadChart(id) {
      domtoimage.toBlob(document.getElementById('chart' + id)).then(function (blob) {
        window.saveAs(blob, 'my-chart.png')
      })
    },

    handleChartJson(id) {
      const targetObject = this.widgets.find((item) => item.i === id)
      this.chartsConfig = targetObject?.data
    },

    onJsonChange(e) {
      this.chartJson = e
    },

    handleUploadedFile() {
      this.isLoading = true

      window.addEventListener(
        'focus',
        () => {
          this.isLoading = false
        },
        { once: true }
      )

      this.$refs.uploadedFile.click()
    },

    onUploadChange(e) {
      try {
        var reader = new FileReader()
        reader.readAsBinaryString(e.target.files[0])
        reader.onload = (e) => {
          var jsonData = []
          var headers = []
          var rows = e.target.result.split('\r\n')
          for (var i = 0; i < rows.length; i++) {
            var cells = rows[i].split(',')
            var rowData = {}
            for (var j = 0; j < cells.length; j++) {
              if (i == 0) {
                var headerName = cells[j].trim()
                headers.push(headerName)
              } else {
                var key = headers[j]
                if (key) {
                  rowData[key] = cells[j].trim()
                }
              }
            }
            //skip the first row (header) data
            if (i != 0) {
              this.uploadFile.push(rowData)
            }
          }

          // Get dimensions
          const allKeys = new Set()
          for (const item of this.uploadFile) {
            const keys = Object.keys(item)
            keys.forEach((key) => allKeys.add(key))
          }
          const dimensions = Array.from(allKeys)
          const keyToFind = 'createdAt'
          const index = dimensions.indexOf(keyToFind)

          this.defaultCategory = dimensions[index]
          this.defaultMetric = dimensions[1]

          this.uploadedData = {
            uploadFile: this.uploadFile,
            uploadedCategory: this.defaultCategory,
            uploadedMetric: this.defaultMetric
          }
        }
      } catch (e) {
        console.error(e)
      }
    },

    handleFileImport() {
      this.isSelecting = true

      window.addEventListener(
        'focus',
        () => {
          this.isSelecting = false
        },
        { once: true }
      )

      this.$refs.uploader.click()
    },

    onFileChanged(e) {
      // this.selectedFile = e.target.files[0]
      // this.getRandomColor()
      // const reader = new FileReader()
      // reader.onload = (e) => {
      //   this.selectedFile = JSON.parse(e.target.result)
      //   this.apexOptions.xaxis.categories = this.selectedFile.map((row) => row['label'])
      //   this.options.xAxis.data = this.selectedFile.map((row) => row['label'])
      //   const blendData = {
      //     name: this.seriesName,
      //     color: '#' + this.randomColor,
      //     data: this.selectedFile,
      //     type: this.modifiedType ? this.modifiedType : this.chartType
      //   }
      //   this.options.series.push(blendData)
      //   this.apexOptions.series.push(blendData)
      // }
      // reader.readAsText(e.target.files[0])
    },

    getApiData(api) {
      axios
        .get(api)
        .then((response) => {
          const responseData = response.data
          this.apiData = responseData

          // Get dimensions
          const allKeys = new Set()
          for (const item of responseData) {
            const keys = Object.keys(item)
            keys.forEach((key) => allKeys.add(key))
          }
          const dimensions = Array.from(allKeys)
          const keyToFind = 'createdAt'
          const index = dimensions.indexOf(keyToFind)

          this.defaultCategory = dimensions[index]
          this.defaultMetric = dimensions[4]

          this.serviceUrl = {
            defaultFile: responseData,
            defaultCategory: this.defaultCategory,
            defaultMetric: this.defaultMetric
          }
        })
        .catch(() => {})
        .finally()
    }
  }
}
</script>

<style scoped>
.vue-grid-item.resizing {
  opacity: 0.9;
}

.remove {
  position: absolute;
  right: 2px;
  top: 0;
  cursor: pointer;
  display: none;
}

.uploadData {
  border: 1px dashed;
  width: inherit;
}
</style>
